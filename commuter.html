<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Find Your Bus - MitrYaan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link href="style.css" rel="stylesheet" />
</head>

<body>
    <div class="container py-4">
        <header class="card mb-4 p-3">
            <div class="d-flex align-items-center gap-3">
                <a class="back-btn" href="index.html" id="back-button">&larr;</a>
                <img alt="MitrYaan Logo" height="80" src="logo.png" />
                <h1 class="h3 mb-0" id="header-title">Find Your Bus</h1>
            </div>
        </header>

        <main>
            <!-- Destination Search View -->
            <div class="view active" id="destination-search-view">
                <div class="card p-4">
                    <h2 class="h4 mb-4">Where do you want to go?</h2>
                    <div class="mb-3">
                        <label class="form-label" for="destination-input">Enter your destination</label>
                        <input class="form-control" id="destination-input" placeholder="e.g., Vellore Fort, VIT"
                            type="text" />
                    </div>
                    <button class="btn btn-primary" id="find-bus-btn">Find Bus</button>
                    <button id="detectLocationBtn" class="my-2 btn btn-primary">Detect Location Automatically</button>
                </div>
            </div>

            <!-- Route Results View -->
            <div class="view" id="route-results-view">
                <h2 class="h4 mb-4">Available Routes</h2>
                <div class="list-group">
                    <!-- Route buttons will be injected here dynamically -->
                </div>
            </div>

            <!-- Bus Tracking View -->
            <div class="view" id="bus-tracking-view">
                <div class="card p-3 mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="h5 mb-0" id="selected-route-text">Bus for </h3>
                        <div class="form-check form-switch">
                            <input class="form-check-input" id="lite-mode-toggle" type="checkbox" />
                            <label class="form-check-label" for="lite-mode-toggle">Lite Mode</label>
                        </div>
                    </div>
                </div>

                <div id="map-view">
                    <div class="card p-4 text-center map-container">
                        <div id="map" style="height: 400px;"></div> <!-- Leaflet will render here -->
                    </div>
                </div>

                <div class="card p-4" id="lite-view" style="display: none;">
                    <p class="mb-0"><strong>Estimated Time to Reach:</strong> 6 minutes</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const views = document.querySelectorAll('.view');
        const headerTitle = document.getElementById('header-title');
        const backButton = document.getElementById('back-button');
        const findBusBtn = document.getElementById('find-bus-btn');
        const toggle = document.getElementById('lite-mode-toggle');
        const mapView = document.getElementById('map-view');
        const liteView = document.getElementById('lite-view');

        function showView(viewId) {
            views.forEach(view => view.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            updateHeader(viewId);
        }

        function updateHeader(viewId) {
            if (viewId === 'destination-search-view') {
                headerTitle.textContent = 'Find Your Bus';
                backButton.href = 'index.html';
                backButton.onclick = null;
            } else if (viewId === 'route-results-view') {
                headerTitle.textContent = 'Available Routes';
                backButton.href = '#';
                backButton.onclick = () => showView('destination-search-view');
            } else if (viewId === 'bus-tracking-view') {
                const selectedRoute = document.querySelector('.route-result-card.selected')?.dataset.route || '';
                headerTitle.textContent = `Tracking Route ${selectedRoute}`;
                backButton.href = '#';
                backButton.onclick = () => showView('route-results-view');
            }
        }

        findBusBtn.addEventListener('click', () => {
            showView('route-results-view');
        });

        toggle.addEventListener('change', function () {
            if (this.checked) {
                mapView.style.display = 'none';
                liteView.style.display = 'block';
            } else {
                mapView.style.display = 'block';
                liteView.style.display = 'none';
            }
        });

        async function findBus(lat, lng) {
            localStorage.setItem("userLat", lat);
            localStorage.setItem("userLng", lng);

            try {
                const response = await fetch("http://localhost:3000/search-busses", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ lat, lng }),
                });

                const data = await response.json();
                const routeListContainer = document.querySelector('#route-results-view .list-group');
                routeListContainer.innerHTML = "";

                if (!data.buses || data.buses.length === 0) {
                    const noResult = document.createElement("p");
                    noResult.textContent = "No buses found nearby.";
                    noResult.classList.add("text-center", "text-secondary");
                    routeListContainer.appendChild(noResult);
                    showView('route-results-view');
                    return;
                }

                data.buses.forEach(bus => {
                    const btn = document.createElement("button");
                    btn.className = "card p-3 mb-2 text-start route-result-card";
                    btn.dataset.busId = bus.busId;
                    btn.dataset.route = bus.route || "Unknown Route";

                    btn.innerHTML = `
        <h3 class="h5 mb-1">${bus.route || "Unknown Route"}</h3>
        <p class="mb-0 text-secondary">Bus ID: ${bus.busId}</p>
    `;

                    btn.addEventListener("click", () => {
                        localStorage.setItem("busId", bus.busId);
                        localStorage.setItem("busRoute", bus.route || "Unknown Route");
                        // redirect to mapView.html
                        window.location.href = "mapView.html";
                    });

                    routeListContainer.appendChild(btn);
                });

                showView('route-results-view');

            } catch (err) {
                console.error(err);
                alert("Failed to fetch nearby buses");
            }
        }

        document.getElementById("detectLocationBtn").addEventListener("click", () => {
            if (!navigator.geolocation) {
                alert("Geolocation is not supported by your browser");
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    findBus(latitude, longitude);
                },
                (err) => {
                    console.error(err);
                    alert("Unable to get your location");
                },
                { enableHighAccuracy: true }
            );
        });
    </script>
</body>

</html>